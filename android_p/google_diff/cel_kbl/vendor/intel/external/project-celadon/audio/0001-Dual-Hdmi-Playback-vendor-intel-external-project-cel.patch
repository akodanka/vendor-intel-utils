From ddafbc4eb5ae3ff9fd1f381e3b479b2b9be20e89 Mon Sep 17 00:00:00 2001
From: akodanka <anoob.anto.kodankandath@gmail.com>
Date: Tue, 19 Feb 2019 02:42:20 +0530
Subject: [PATCH] Dual Hdmi Playback
 /vendor/intel/external/project-celadon/audio/

Tracked-On:
Signed-off-by: akodanka <anoob.anto.kodankandath@gmail.com>
---
 audio_hw.c | 26 +++++++++++++++++++-------
 1 file changed, 19 insertions(+), 7 deletions(-)

diff --git a/audio_hw.c b/audio_hw.c
index bdbe7f8..f083aba 100644
--- a/audio_hw.c
+++ b/audio_hw.c
@@ -98,6 +98,7 @@ struct stream_out {
     bool unavailable;
     bool standby;
     uint64_t written;
+    audio_output_flags_t flags;
     struct audio_device *dev;
 };
 
@@ -130,7 +131,8 @@ static void select_devices(struct audio_device *adev)
 
     headphone_on = adev->out_device & (AUDIO_DEVICE_OUT_WIRED_HEADSET |
                                     AUDIO_DEVICE_OUT_WIRED_HEADPHONE);
-    speaker_on = adev->out_device & AUDIO_DEVICE_OUT_SPEAKER;
+    speaker_on = adev->out_device & (AUDIO_DEVICE_OUT_SPEAKER |
+                                    AUDIO_DEVICE_OUT_HDMI);
     main_mic_on = adev->in_device & AUDIO_DEVICE_IN_BUILTIN_MIC;
     headset_mic_on = adev->in_device & AUDIO_DEVICE_IN_WIRED_HEADSET;
 
@@ -219,9 +221,18 @@ static int start_output_stream(struct stream_out *out)
         adev->card = get_pcm_card("Dummy");
     }
 
-    ALOGE("PCM card selected = %d, \n", adev->card);
- 
-    out->pcm = pcm_open(adev->card, PCM_DEVICE, PCM_OUT | PCM_NORESTART | PCM_MONOTONIC, out->pcm_config);
+    int deviceId = PCM_DEVICE;
+    if (adev->out_device & AUDIO_DEVICE_OUT_HDMI)
+    {
+        adev->card = PCM_CARD_DEFAULT;
+        deviceId = 3;
+        if (out->flags & AUDIO_OUTPUT_FLAG_SECONDARY_OUT)
+            deviceId = 7;
+    }
+
+    ALOGE("PCM selected card = %d, device = %d \n", adev->card, deviceId);
+
+    out->pcm = pcm_open(adev->card, deviceId, PCM_OUT | PCM_NORESTART | PCM_MONOTONIC, out->pcm_config);
 
     if (!out->pcm) {
         ALOGE("pcm_open(out) failed: device not found");
@@ -725,13 +736,13 @@ static int in_remove_audio_effect(const struct audio_stream *stream __unused,
 static int adev_open_output_stream(struct audio_hw_device *dev,
                                    audio_io_handle_t handle __unused,
                                    audio_devices_t devices __unused,
-                                   audio_output_flags_t flags __unused,
+                                   audio_output_flags_t flags,
                                    struct audio_config *config,
                                    struct audio_stream_out **stream_out,
                                    const char *address __unused)
 {
-    ALOGV("%s : config : [rate %d format %d channels %d]",__func__,
-        config->sample_rate, config->format, popcount(config->channel_mask));
+    ALOGV("%s : config : [rate %d format %d channels %d flags %08x]",__func__,
+        config->sample_rate, config->format, popcount(config->channel_mask), flags);
 
     struct audio_device *adev = (struct audio_device *)dev;
     struct stream_out *out;
@@ -779,6 +790,7 @@ static int adev_open_output_stream(struct audio_hw_device *dev,
 
     out->pcm_config = &pcm_config_out;
     out->written = 0;
+    out->flags = flags;
 
 // VTS : Device doesn't support mono channel or sample_rate other than 48000
 //       make a copy of requested config to feed it back if requested.
-- 
2.20.1

